{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "EOL Host Test Sequence",
  "type": "object",
  "properties": {
    "tests": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name","type","actuation"],
        "properties": {
          "name": {"type":"string"},
          "type": {"type":"string","enum":["Digital Logic Test","Analog Sweep Test","Phase Current Test","Analog Static Test","Analog PWM Sensor","Temperature Validation Test","Fan Control Test","External 5V Test","DC Bus Sensing","Output Current Calibration","Charged HV Bus Test","Charger Functional Test"]},
          "feedback_signal": {"type":["string","null"]},
          "test_mode": {"type":"integer", "minimum":0, "maximum":3, "default":0},
          "actuation": {
            "type": "object",
            "oneOf": [
              {"properties": {"type":{"const":"Digital Logic Test"}, "can_id":{"type":"integer"}, "signal":{"type":"string"}, "value":{"type":["string","integer"]}}, "required":["can_id"]},
              {"properties": {"type":{"const":"Analog Sweep Test"}, "mux_channel":{"type":["integer","null"]}, "dac_can_id":{"type":"integer"}, "dac_command":{"type":"string"}}, "required":["dac_can_id"]},
              {
                "properties": {
                  "type": {"const":"Temperature Validation Test"},
                  "feedback_signal_source": {"type":"integer"},
                  "feedback_signal": {"type":"string"},
                  "reference_temperature_c": {"type":"number"},
                  "tolerance_c": {"type":"number", "minimum":0},
                  "dwell_time_ms": {"type":"integer", "minimum":1}
                },
                "required": [
                  "feedback_signal_source",
                  "feedback_signal",
                  "reference_temperature_c",
                  "tolerance_c",
                  "dwell_time_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Fan Control Test"},
                  "fan_test_trigger_source": {"type":"integer"},
                  "fan_test_trigger_signal": {"type":"string"},
                  "fan_control_feedback_source": {"type":"integer"},
                  "fan_enabled_signal": {"type":"string"},
                  "fan_tach_feedback_signal": {"type":"string"},
                  "fan_fault_feedback_signal": {"type":"string"},
                  "dwell_time_ms": {"type":"integer", "minimum":1},
                  "test_timeout_ms": {"type":"integer", "minimum":1}
                },
                "required": [
                  "fan_test_trigger_source",
                  "fan_test_trigger_signal",
                  "fan_control_feedback_source",
                  "fan_enabled_signal",
                  "fan_tach_feedback_signal",
                  "fan_fault_feedback_signal",
                  "dwell_time_ms",
                  "test_timeout_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Analog Static Test"},
                  "feedback_signal_source": {"type":"integer"},
                  "feedback_signal": {"type":"string"},
                  "eol_signal_source": {"type":"integer"},
                  "eol_signal": {"type":"string"},
                  "tolerance_mv": {"type":"number", "minimum":0},
                  "pre_dwell_time_ms": {"type":"integer", "minimum":0},
                  "dwell_time_ms": {"type":"integer", "minimum":1}
                },
                "required": [
                  "feedback_signal_source",
                  "feedback_signal",
                  "eol_signal_source",
                  "eol_signal",
                  "tolerance_mv",
                  "pre_dwell_time_ms",
                  "dwell_time_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Analog PWM Sensor"},
                  "feedback_signal_source": {"type":"integer"},
                  "feedback_pwm_frequency_signal": {"type":"string"},
                  "feedback_duty_signal": {"type":"string"},
                  "reference_pwm_frequency": {"type":"number"},
                  "reference_duty": {"type":"number"},
                  "pwm_frequency_tolerance": {"type":"number", "minimum":0},
                  "duty_tolerance": {"type":"number", "minimum":0},
                  "acquisition_time_ms": {"type":"integer", "minimum":1}
                },
                "required": [
                  "feedback_signal_source",
                  "feedback_pwm_frequency_signal",
                  "feedback_duty_signal",
                  "reference_pwm_frequency",
                  "reference_duty",
                  "pwm_frequency_tolerance",
                  "duty_tolerance",
                  "acquisition_time_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"External 5V Test"},
                  "ext_5v_test_trigger_source": {"type":"integer"},
                  "ext_5v_test_trigger_signal": {"type":"string"},
                  "eol_ext_5v_measurement_source": {"type":"integer"},
                  "eol_ext_5v_measurement_signal": {"type":"string"},
                  "feedback_signal_source": {"type":"integer"},
                  "feedback_signal": {"type":"string"},
                  "tolerance_mv": {"type":"number", "minimum":0},
                  "pre_dwell_time_ms": {"type":"integer", "minimum":0},
                  "dwell_time_ms": {"type":"integer", "minimum":1}
                },
                "required": [
                  "ext_5v_test_trigger_source",
                  "ext_5v_test_trigger_signal",
                  "eol_ext_5v_measurement_source",
                  "eol_ext_5v_measurement_signal",
                  "feedback_signal_source",
                  "feedback_signal",
                  "tolerance_mv",
                  "pre_dwell_time_ms",
                  "dwell_time_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"DC Bus Sensing"},
                  "oscilloscope_channel": {"type":"string"},
                  "feedback_signal_source": {"type":"integer"},
                  "feedback_signal": {"type":"string"},
                  "dwell_time_ms": {"type":"integer", "minimum":1},
                  "tolerance_v": {"type":"number", "minimum":0}
                },
                "required": [
                  "oscilloscope_channel",
                  "feedback_signal_source",
                  "feedback_signal",
                  "dwell_time_ms",
                  "tolerance_v"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Output Current Calibration"},
                  "test_trigger_source": {"type":"integer", "minimum":0, "maximum":536870911},
                  "test_trigger_signal": {"type":"string"},
                  "test_trigger_signal_value": {"type":"integer", "minimum":0, "maximum":255},
                  "current_setpoint_signal": {"type":"string"},
                  "output_current_trim_signal": {"type":"string"},
                  "initial_trim_value": {"type":"number", "minimum":0.0, "maximum":200.0},
                  "feedback_signal_source": {"type":"integer", "minimum":0, "maximum":536870911},
                  "feedback_signal": {"type":"string"},
                  "oscilloscope_channel": {"type":"string"},
                  "oscilloscope_timebase": {"type":"string", "enum":["10MS","20MS","100MS","500MS"]},
                  "minimum_test_current": {"type":"number", "minimum":0},
                  "maximum_test_current": {"type":"number", "minimum":0},
                  "step_current": {"type":"number", "minimum":0.1},
                  "pre_acquisition_time_ms": {"type":"integer", "minimum":0},
                  "acquisition_time_ms": {"type":"integer", "minimum":1},
                  "tolerance_percent": {"type":"number", "minimum":0}
                },
                "required": [
                  "test_trigger_source",
                  "test_trigger_signal",
                  "test_trigger_signal_value",
                  "current_setpoint_signal",
                  "output_current_trim_signal",
                  "initial_trim_value",
                  "feedback_signal_source",
                  "feedback_signal",
                  "oscilloscope_channel",
                  "oscilloscope_timebase",
                  "minimum_test_current",
                  "maximum_test_current",
                  "step_current",
                  "pre_acquisition_time_ms",
                  "acquisition_time_ms",
                  "tolerance_percent"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Charged HV Bus Test"},
                  "command_signal_source": {"type":"integer", "minimum":0, "maximum":536870911},
                  "test_trigger_signal": {"type":"string"},
                  "test_trigger_signal_value": {"type":"integer", "minimum":0, "maximum":255},
                  "set_output_current_trim_signal": {"type":"string"},
                  "fallback_output_current_trim_value": {"type":"number", "minimum":0, "maximum":200},
                  "set_output_current_setpoint_signal": {"type":"string"},
                  "output_test_current": {"type":"number", "minimum":0, "maximum":40},
                  "feedback_signal_source": {"type":"integer", "minimum":0, "maximum":536870911},
                  "dut_test_state_signal": {"type":"string"},
                  "enable_relay_signal": {"type":"string"},
                  "enable_pfc_signal": {"type":"string"},
                  "pfc_power_good_signal": {"type":"string"},
                  "pcmc_signal": {"type":"string"},
                  "psfb_fault_signal": {"type":"string"},
                  "test_time_ms": {"type":"integer", "minimum":1000}
                },
                "required": [
                  "command_signal_source",
                  "test_trigger_signal",
                  "test_trigger_signal_value",
                  "set_output_current_trim_signal",
                  "fallback_output_current_trim_value",
                  "set_output_current_setpoint_signal",
                  "output_test_current",
                  "feedback_signal_source",
                  "dut_test_state_signal",
                  "enable_relay_signal",
                  "enable_pfc_signal",
                  "pfc_power_good_signal",
                  "pcmc_signal",
                  "psfb_fault_signal",
                  "test_time_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Charger Functional Test"},
                  "command_signal_source": {"type":"integer", "minimum":0, "maximum":536870911},
                  "test_trigger_signal": {"type":"string"},
                  "test_trigger_signal_value": {"type":"integer", "minimum":0, "maximum":255},
                  "set_output_current_trim_signal": {"type":"string"},
                  "fallback_output_current_trim_value": {"type":"number", "minimum":0, "maximum":200},
                  "set_output_current_setpoint_signal": {"type":"string"},
                  "output_test_current": {"type":"number", "minimum":0, "maximum":40},
                  "feedback_signal_source": {"type":"integer", "minimum":0, "maximum":536870911},
                  "dut_test_state_signal": {"type":"string"},
                  "enable_relay_signal": {"type":"string"},
                  "enable_pfc_signal": {"type":"string"},
                  "pfc_power_good_signal": {"type":"string"},
                  "pcmc_signal": {"type":"string"},
                  "output_current_signal": {"type":"string"},
                  "psfb_fault_signal": {"type":"string"},
                  "output_current_tolerance": {"type":"number", "minimum":0},
                  "test_time_ms": {"type":"integer", "minimum":1000}
                },
                "required": [
                  "command_signal_source",
                  "test_trigger_signal",
                  "test_trigger_signal_value",
                  "set_output_current_trim_signal",
                  "fallback_output_current_trim_value",
                  "set_output_current_setpoint_signal",
                  "output_test_current",
                  "feedback_signal_source",
                  "dut_test_state_signal",
                  "enable_relay_signal",
                  "enable_pfc_signal",
                  "pfc_power_good_signal",
                  "pcmc_signal",
                  "output_current_signal",
                  "psfb_fault_signal",
                  "output_current_tolerance",
                  "test_time_ms"
                ]
              },
              {
                "properties": {
                  "type": {"const":"Phase Current Test"},
                  "can_id": {"type":"integer"},
                  "message_type": {"type":"integer"},
                  "device_id": {"type":"integer"},
                  "enable_signal": {"type":"string"},
                  "id_ref_signal": {"type":"string"},
                  "iq_ref_signal": {"type":"string"},
                  "test_points": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "id_ref": {"type":"number"},
                        "iq_ref": {"type":"number"}
                      },
                      "required": ["id_ref", "iq_ref"]
                    },
                    "minItems": 1
                  },
                  "oscilloscope": {
                    "type": "object",
                    "properties": {
                      "model": {"type":"string"},
                      "connection": {
                        "type": "object",
                        "properties": {
                          "type": {"type":"string", "enum":["usb", "ethernet", "serial"]},
                          "address": {"type":"string"}
                        },
                        "required": ["type", "address"]
                      },
                      "channels": {
                        "type": "object",
                        "properties": {
                          "channel_1": {
                            "type": "object",
                            "properties": {
                              "name": {"type":"string"},
                              "unit": {"type":"string"},
                              "probe_attenuation": {"type":"number"},
                              "scale": {"type":"number"}
                            },
                            "required": ["name", "unit", "probe_attenuation", "scale"]
                          },
                          "channel_2": {
                            "type": "object",
                            "properties": {
                              "name": {"type":"string"},
                              "unit": {"type":"string"},
                              "probe_attenuation": {"type":"number"},
                              "scale": {"type":"number"}
                            },
                            "required": ["name", "unit", "probe_attenuation", "scale"]
                          }
                        },
                        "required": ["channel_1", "channel_2"]
                      },
                      "trigger": {
                        "type": "object",
                        "properties": {
                          "mode": {"type":"string", "enum":["single", "normal", "auto"]},
                          "source": {"type":"string"},
                          "level_percent": {"type":"number", "minimum":0, "maximum":100}
                        },
                        "required": ["mode"]
                      }
                    },
                    "required": ["model", "connection", "channels", "trigger"]
                  },
                  "timing": {
                    "type": "object",
                    "properties": {
                      "pre_trigger_wait_ms": {"type":"integer", "minimum":0},
                      "test_duration_ms": {"type":"integer", "minimum":1000},
                      "extended_collection_ms": {"type":"integer", "minimum":3000}
                    },
                    "required": ["pre_trigger_wait_ms", "test_duration_ms", "extended_collection_ms"]
                  },
                  "data_collection": {
                    "type": "object",
                    "properties": {
                      "can_message_id": {"type":"integer"},
                      "can_message_type": {"type":"integer"},
                      "phase_v_signal": {"type":"string"},
                      "phase_w_signal": {"type":"string"},
                      "sampling_rate_hz": {"type":"integer"}
                    },
                    "required": ["can_message_id", "can_message_type", "phase_v_signal", "phase_w_signal"]
                  },
                  "steady_state_detection": {
                    "type": "object",
                    "properties": {
                      "derivative_window_ms": {"type":"integer"},
                      "ramp_threshold_a_per_sec": {"type":"number"},
                      "stability_duration_ms": {"type":"integer"},
                      "drop_threshold_percent": {"type":"number"},
                      "minimum_steady_state_duration_ms": {"type":"integer"},
                      "minimum_samples": {"type":"integer"},
                      "max_std_threshold_percent": {"type":"number"},
                      "time_sync_tolerance_ms": {"type":"integer"}
                    }
                  }
                },
                "required": [
                  "can_id",
                  "message_type",
                  "device_id",
                  "test_points",
                  "oscilloscope",
                  "timing",
                  "data_collection"
                ]
              }
            ]
          }
        }
      }
    }
  }
}
